@if (planDetail; as detail) {
<mat-card
  appearance="outlined"
  class="plan-detail-card"
  (click)="onCardClick()"
>
  <mat-card-header>
    <div class="flex w-full justify-between items-center">
      <!-- Avatar + Título/Subtítulo -->
      <div class="flex items-center gap-3">
        <div mat-card-avatar class="example-header-image"></div>
        <div>
          <mat-card-title>
            {{ detail.capitulo.titulo_capitulo }}
          </mat-card-title>
          <mat-card-subtitle class="text-sm text-gray-600">
            Capítulo {{ detail.capitulo.numero_capitulo }}
          </mat-card-subtitle>
        </div>
      </div>

      <!-- Checkbox -->
      <div>
        @if (!detail.leido) {
        <mat-checkbox
          [checked]="isCompleted()"
          (change)="onCompletedChange($event.checked)"
          color="primary"
        >
        </mat-checkbox>
        }
      </div>
    </div>
  </mat-card-header>

  <mat-card-content class="mt-4">
    <!-- Información adicional si está completado -->
    @if (detail.leido && detail.fecha_completado) {
    <div class="completed-info mb-4 p-3  rounded-lg">
      <div class="text-sm font-medium text-green-800 mb-2">
        Información de lectura
      </div>
      <div class="text-xs text-green-700 mb-1">
        Completado: {{ formatDate(detail.fecha_completado) }}
      </div>
      @if (detail.tiempo_real_minutos) {
      <div class="text-xs text-green-700 mb-1">
        Tiempo real: {{ detail.tiempo_real_minutos }} minutos
      </div>
      } @if (detail.dificultad_percibida) {
      <div class="text-xs text-green-700 mb-1">
        Dificultad: {{ getDifficultyText(detail.dificultad_percibida) }}
      </div>
      } @if (detail.notas) {
      <div class="text-xs text-green-700">Notas: {{ detail.notas }}</div>
      }
    </div>
    }
  </mat-card-content>

  <mat-card-footer class="mt-4 px-4">
    <mat-chip-set>
      @if (detail.leido) {
      <mat-chip color="primary">
        <mat-icon matChipAvatar fontIcon="check_circle"></mat-icon>
        Completado
      </mat-chip>
      } @else {
      <mat-chip color="accent">
        <mat-icon matChipAvatar fontIcon="schedule"></mat-icon>
        Pendiente
      </mat-chip>
      } @if (isOverdue()) {
      <mat-chip color="warn">
        <mat-icon matChipAvatar fontIcon="warning"></mat-icon>
        Atrasado
      </mat-chip>
      }

      <mat-chip color="warn">
        <mat-icon matChipAvatar fontIcon="numbers"></mat-icon>
        {{ pageRange() }}&nbsp;pg
      </mat-chip>
      <mat-chip color="warn">
        <mat-icon matChipAvatar fontIcon="access_time"></mat-icon>
        {{ detail.tiempo_estimado_minutos }} minutos
      </mat-chip>
      <mat-chip color="warn">
        <mat-icon matChipAvatar fontIcon="event_available"></mat-icon>
        {{ formatDate(detail.fecha_asignada) }}
      </mat-chip>
    </mat-chip-set>
  </mat-card-footer>
  <mat-card-actions class="">
    @if (showReadForm()) {
    <div class="px-2 w-full">
      <h4 class="text-sm font-medium mb-3">Información de lectura</h4>

      <!-- Tiempo real -->
      <mat-form-field appearance="outline" class="w-full mb-3">
        <mat-label>Tiempo real (minutos)</mat-label>
        <input
          matInput
          type="number"
          [value]="tiempoReal()"
          (input)="tiempoReal.set(+$any($event.target).value)"
          min="1"
        />
      </mat-form-field>

      <div class="mb-2 w-full">
        <label class="text-sm font-medium block mb-2"
          >Dificultad percibida</label
        >
        <mat-slider min="1" max="5" step="1">
          <input
            matSliderThumb
            [value]="dificultad()"
            (input)="dificultad.set($any($event.target).value)"
          />
        </mat-slider>
        <div class="text-xs text-gray-600 mt-1">
          {{ getDifficultyText(dificultad()) }}
        </div>
      </div>

      <mat-form-field appearance="outline" class="w-full mb-2">
        <mat-label>Notas (opcional)</mat-label>
        <textarea
          matInput
          rows="3"
          [value]="notas()"
          (input)="notas.set($any($event.target).value)"
        ></textarea>
      </mat-form-field>

      <!-- Botones -->
      <div class="flex gap-2 justify-end">
        <button mat-stroked-button (click)="onCancelMarkAsRead()">
          Cancelar
        </button>
        <button mat-flat-button color="primary" (click)="onConfirmMarkAsRead()">
          Confirmar
        </button>
      </div>
    </div>
    }
  </mat-card-actions>
</mat-card>
}
